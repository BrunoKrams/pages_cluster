---
- name: Ensure k3s is installed
  become: true
  block:
    - name: Check if k3s binary exists
      command: which k3s
      register: k3s_check
      ignore_errors: true
      changed_when: false

    - name: Install k3s if missing
      when: k3s_check.rc != 0
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_KUBECONFIG_MODE="644" \
        INSTALL_K3S_EXEC="--flannel-backend=none --cluster-cidr={{ k3s_cluster_cidr }} --disable-network-policy --disable=traefik" sh -
      args:
        warn: false

- name: Apply Calico operator CRDs
  become: true
  shell: |
    k3s kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/operator-crds.yaml
  args:
    warn: false

- name: Apply Tigera operator
  become: true
  shell: |
    k3s kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/tigera-operator.yaml
  args:
    warn: false

- name: Apply Calico custom resources
  become: true
  shell: |
    k3s kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/custom-resources.yaml
  args:
    warn: false

- name: Wait for all pods to become Ready (timeout 5m)
  become: true
  shell: |
    k3s kubectl wait --for=condition=Ready pods --all --all-namespaces --timeout=300s
  register: pods_ready
  failed_when: pods_ready.rc != 0
