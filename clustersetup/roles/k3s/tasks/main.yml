- name: Install k3s
  become: true
  shell: |
    curl -sfL https://get.k3s.io | \
      K3S_KUBECONFIG_MODE="644" \
      INSTALL_K3S_EXEC="--cluster-cidr={{ k3s_cluster_cidr }}" sh -

- name: Verify k3s binary installed
  command: k3s --version
  register: k3s_version
  changed_when: false
  failed_when: k3s_version.rc != 0

- name: Check k3s service is active
  become: true
  command: systemctl is-active k3s
  register: k3s_service
  changed_when: false
  failed_when: k3s_service.stdout.strip() != 'active'

- name: Add Letâ€™s Encrypt support
  template:
    src: traefik-config.j2
    dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml

- name: Fetch K3s kubeconfig from remote server
  when: master_node is defined and master_node
  fetch:
    src: "/etc/rancher/k3s/k3s.yaml"
    dest: "{{ kubeconfig_path }}"
    flat: true
